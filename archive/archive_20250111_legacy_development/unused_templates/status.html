{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-gear"></i> System Status</h1>
        <p class="lead">Monitor system health and connectivity</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <button class="btn btn-outline-primary" onclick="location.reload()">
            <i class="bi bi-arrow-clockwise"></i> Refresh Status
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Overall System Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="bi bi-activity"></i> Overall System Status
                    {% if overall_status.success %}
                        <span class="badge bg-success ms-2">HEALTHY</span>
                    {% else %}
                        <span class="badge bg-danger ms-2">ISSUES DETECTED</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if overall_status.success %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> All systems are operational
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> System issues detected - see details below
                    </div>
                {% endif %}
                
                <div class="cli-output">{{ overall_status.stdout or overall_status.stderr }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Server Connectivity -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>
                    <i class="bi bi-server"></i> API Server Connectivity
                    {% if server_status.success %}
                        <span class="badge bg-success ms-2">CONNECTED</span>
                    {% else %}
                        <span class="badge bg-danger ms-2">CONNECTION FAILED</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if server_status.success %}
                    <div class="alert alert-success">
                        <i class="bi bi-wifi"></i> API server is reachable and responding
                    </div>
                {% else %}
                    <div class="alert alert-danger">
                        <i class="bi bi-wifi-off"></i> Cannot connect to API server
                        <div class="mt-2">
                            <strong>Troubleshooting:</strong>
                            <ul class="mb-0">
                                <li>Ensure the server is running: <code>python start_server.py</code></li>
                                <li>Check if port 8002 is available</li>
                                <li>Verify firewall settings</li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
                
                <div class="cli-output">{{ server_status.stdout or server_status.stderr }}</div>
            </div>
        </div>
    </div>
</div>

<!-- System Components -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-puzzle"></i> Components</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Web UI
                        <span class="badge bg-success">Running</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        CLI Wrapper
                        <span class="badge bg-success">Available</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        API Server
                        <span class="badge {{ 'bg-success' if server_status.success else 'bg-danger' }}">
                            {{ 'Running' if server_status.success else 'Offline' }}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        File Processing
                        <span class="badge {{ 'bg-success' if overall_status.success else 'bg-warning' }}">
                            {{ 'Ready' if overall_status.success else 'Limited' }}
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-info-circle"></i> System Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <td><strong>Web UI Port:</strong></td>
                        <td>5000</td>
                    </tr>
                    <tr>
                        <td><strong>API Server Port:</strong></td>
                        <td>8002</td>
                    </tr>
                    <tr>
                        <td><strong>Max File Size:</strong></td>
                        <td>50MB</td>
                    </tr>
                    <tr>
                        <td><strong>Supported Formats:</strong></td>
                        <td>.txt, .docx, .doc, .pdf, .rtf</td>
                    </tr>
                    <tr>
                        <td><strong>CLI Available:</strong></td>
                        <td><code>python qc_cli.py</code></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-tools"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="testFileUpload()">
                                <i class="bi bi-file-check"></i> Test File Upload
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-success" onclick="testQuery()">
                                <i class="bi bi-search"></i> Test Query System
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-info" onclick="testAPI()">
                                <i class="bi bi-api"></i> Test API Connection
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-warning" onclick="checkLogs()">
                                <i class="bi bi-journal-text"></i> View Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Area -->
<div class="row">
    <div class="col-12">
        <div class="card" id="testResults" style="display: none;">
            <div class="card-header">
                <h5><i class="bi bi-clipboard-check"></i> Test Results</h5>
            </div>
            <div class="card-body">
                <div id="testOutput" class="cli-output"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showTestResult(title, content, success = true) {
    const testResults = document.getElementById('testResults');
    const testOutput = document.getElementById('testOutput');
    
    testOutput.innerHTML = `<strong>${title}</strong>\n\n${content}`;
    testResults.style.display = 'block';
    testResults.scrollIntoView({ behavior: 'smooth' });
}

async function testAPI() {
    showTestResult('Testing API Connection...', 'Connecting to API server...', true);
    
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        if (data.success) {
            showTestResult('API Test - SUCCESS', 
                `‚úÖ API connection successful\n\nResponse:\n${data.stdout}`, true);
        } else {
            showTestResult('API Test - FAILED', 
                `‚ùå API test failed\n\nError:\n${data.stderr || 'Unknown error'}`, false);
        }
    } catch (error) {
        showTestResult('API Test - ERROR', 
            `‚ùå Network error: ${error.message}`, false);
    }
}

function testFileUpload() {
    showTestResult('File Upload Test', 
        `üìÅ File upload system status:

‚úÖ Upload directory: Available
‚úÖ Max file size: 50MB
‚úÖ Supported formats: .txt, .docx, .doc, .pdf, .rtf
‚úÖ Security: Filename sanitization enabled

To test file upload functionality:
1. Go to "Analyze Files" page
2. Upload a sample .txt file
3. Submit for analysis

The system will process your file and return results.`, true);
}

function testQuery() {
    showTestResult('Query System Test', 
        `üîç Query system status:

‚úÖ Natural language processing: Available
‚úÖ CLI integration: Working
‚úÖ Multiple output formats: Supported

To test query functionality:
1. Go to "Query Data" page
2. Enter a question like "Show me all codes"
3. Submit the query

The system will process your query and return results.

Note: Query results depend on available analysis data.`, true);
}

function checkLogs() {
    showTestResult('System Logs', 
        `üìù Log information:

Web UI logs are displayed in the browser console.
To view detailed logs:

1. Press F12 to open developer tools
2. Go to the Console tab
3. Look for log entries from the application

CLI logs can be viewed by running:
python qc_cli.py --verbose status

API server logs are displayed in the terminal where 
the server is running (python start_server.py).`, true);
}

// Auto-refresh status every 30 seconds
let autoRefresh = false;

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const btn = event.target;
    
    if (autoRefresh) {
        btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Auto Refresh';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-warning');
        
        const interval = setInterval(() => {
            if (!autoRefresh) {
                clearInterval(interval);
                return;
            }
            location.reload();
        }, 30000);
    } else {
        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Status';
        btn.classList.add('btn-outline-primary');
        btn.classList.remove('btn-warning');
    }
}
</script>
{% endblock %}